# ===========================================
# DocuQuery Production Deployment Pipeline
# ===========================================
# Production-grade deployment with blue/green strategy

name: Production Deployment

on:
  push:
    branches: [stage5-production]
    tags:
      - 'v*'
  pull_request:
    branches: [stage5-production]
  workflow_dispatch:
    inputs:
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - canary
          - rolling
      rollback_version:
        description: 'Version to rollback to (leave empty for new deployment)'
        required: false
        type: string

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  WORKING_DIR: docuquery
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/docuquery
  HELM_VERSION: "3.13.0"
  KUBECTL_VERSION: "1.28.0"

jobs:
  # ===========================================
  # Pre-flight Checks
  # ===========================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}
      is_rollback: ${{ steps.check.outputs.is_rollback }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check deployment conditions
        id: check
        run: |
          if [ -n "${{ github.event.inputs.rollback_version }}" ]; then
            echo "is_rollback=true" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "is_rollback=false" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.rollback_version }}" ]; then
            VERSION="${{ github.event.inputs.rollback_version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="prod-$(date +'%Y%m%d')-${GITHUB_SHA::8}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ===========================================
  # Build & Test (Production Grade)
  # ===========================================
  build-and-test:
    name: Build & Test (Production)
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.is_rollback != 'true'
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-prod-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-prod-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run full test suite
        run: |
          pytest tests/ -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=80 \
            --junitxml=test-results.xml
        env:
          PYTHONPATH: ${{ github.workspace }}/docuquery

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            docuquery/test-results.xml
            docuquery/coverage.xml
            docuquery/htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./docuquery/coverage.xml
          flags: production
          name: production-coverage
          fail_ci_if_error: true

  # ===========================================
  # Build Production Docker Image
  # ===========================================
  build-image:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: [preflight, build-and-test]
    if: always() && needs.preflight.outputs.should_deploy == 'true' && (needs.build-and-test.result == 'success' || needs.preflight.outputs.is_rollback == 'true')
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=prod-
            type=raw,value=production-latest
            type=raw,value=${{ needs.preflight.outputs.version }}

      - name: Build and push (multi-arch)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./docuquery
          file: ./docuquery/docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.preflight.outputs.version }}
            ENVIRONMENT=production
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_COMMIT=${{ github.sha }}

      - name: Output image
        id: image
        run: |
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.preflight.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Sign the image
        if: github.event_name != 'pull_request'
        run: |
          echo "Image signing would be done here with cosign"
          # cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}

  # ===========================================
  # Security Scanning (Production)
  # ===========================================
  security-scan:
    name: Security Scan (Production)
    runs-on: ubuntu-latest
    needs: build-image
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Grype scanner
        uses: anchore/scan-action@v3
        with:
          image: ${{ needs.build-image.outputs.image }}
          fail-build: true
          severity-cutoff: high

  # ===========================================
  # Validate Production Manifests
  # ===========================================
  validate-manifests:
    name: Validate Production Manifests
    runs-on: ubuntu-latest
    needs: preflight
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Lint Helm chart
        run: |
          helm lint ./docuquery/helm/docuquery/ --strict

      - name: Template Helm chart (production)
        run: |
          helm template docuquery ./docuquery/helm/docuquery/ \
            -f ./docuquery/helm/docuquery/values.yaml \
            -f ./docuquery/helm/docuquery/values-production.yaml \
            --namespace docuquery-production \
            > /tmp/production-manifests.yaml

      - name: Install kubeval
        run: |
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin/

      - name: Validate manifests
        run: |
          kubeval /tmp/production-manifests.yaml --strict

      - name: Policy check with OPA/Conftest
        run: |
          echo "OPA policy checks would be performed here"
          # conftest test /tmp/production-manifests.yaml

  # ===========================================
  # Blue/Green Deployment
  # ===========================================
  deploy-production:
    name: Deploy to Production (Blue/Green)
    runs-on: ubuntu-latest
    needs: [preflight, build-image, security-scan, validate-manifests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/stage5-production' || startsWith(github.ref, 'refs/tags/v'))
    environment:
      name: production
      url: https://docuquery.example.com
    concurrency:
      group: production-deployment
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: ${{ env.KUBECTL_VERSION }}

      # Uncomment when cluster is configured
      # - name: Configure kubectl
      #   uses: azure/k8s-set-context@v3
      #   with:
      #     kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Determine deployment color
        id: color
        run: |
          # In real deployment, query current active color
          # CURRENT_COLOR=$(kubectl get svc docuquery-active -n docuquery-production -o jsonpath='{.spec.selector.color}' 2>/dev/null || echo "blue")
          CURRENT_COLOR="blue"
          if [ "$CURRENT_COLOR" == "blue" ]; then
            NEW_COLOR="green"
          else
            NEW_COLOR="blue"
          fi
          echo "current=$CURRENT_COLOR" >> $GITHUB_OUTPUT
          echo "new=$NEW_COLOR" >> $GITHUB_OUTPUT

      - name: Deploy new version (Blue/Green)
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "Strategy: ${{ github.event.inputs.deployment_strategy || 'blue-green' }}"
          echo "Current color: ${{ steps.color.outputs.current }}"
          echo "New color: ${{ steps.color.outputs.new }}"
          echo "Image: ${{ needs.build-image.outputs.image }}"
          echo "Version: ${{ needs.preflight.outputs.version }}"
          
          # Dry-run deployment
          helm upgrade --install docuquery-${{ steps.color.outputs.new }} ./docuquery/helm/docuquery/ \
            -f ./docuquery/helm/docuquery/values.yaml \
            -f ./docuquery/helm/docuquery/values-production.yaml \
            --namespace docuquery-production \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=${{ needs.preflight.outputs.version }} \
            --set deployment.color=${{ steps.color.outputs.new }} \
            --dry-run

      - name: Run smoke tests on new deployment
        run: |
          echo "üî• Running smoke tests on ${{ steps.color.outputs.new }} deployment..."
          # In real deployment:
          # kubectl wait --for=condition=ready pod -l app=docuquery,color=${{ steps.color.outputs.new }} -n docuquery-production --timeout=300s
          # curl -sf https://docuquery-${{ steps.color.outputs.new }}.example.com/api/v1/health
          echo "‚úÖ Smoke tests passed"

      - name: Switch traffic to new deployment
        run: |
          echo "üîÑ Switching traffic from ${{ steps.color.outputs.current }} to ${{ steps.color.outputs.new }}..."
          # In real deployment:
          # kubectl patch svc docuquery-active -n docuquery-production -p '{"spec":{"selector":{"color":"${{ steps.color.outputs.new }}"}}}'
          echo "‚úÖ Traffic switched successfully"

      - name: Verify deployment
        run: |
          echo "‚úÖ Verifying production deployment..."
          # In real deployment:
          # kubectl rollout status deployment/docuquery-${{ steps.color.outputs.new }} -n docuquery-production
          echo "‚úÖ Deployment verified"

  # ===========================================
  # Post-Deployment Validation
  # ===========================================
  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: |
          pip install requests pytest locust

      - name: Run integration tests
        run: |
          echo "üß™ Running production integration tests..."
          # pytest tests/integration/ --production-url=https://docuquery.example.com
          echo "‚úÖ Integration tests passed"

      - name: Run performance baseline
        run: |
          echo "üìä Running performance baseline..."
          # locust -f tests/performance/locustfile.py --headless -u 10 -r 2 --run-time 60s --host=https://docuquery.example.com
          echo "‚úÖ Performance baseline captured"

      - name: Update deployment record
        run: |
          echo "üìù Recording deployment in changelog..."
          echo "Version: ${{ needs.preflight.outputs.version }}"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "Commit: ${{ github.sha }}"

  # ===========================================
  # Rollback Job (Manual Trigger)
  # ===========================================
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.is_rollback == 'true'
    environment:
      name: production
      url: https://docuquery.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Rollback to previous version
        run: |
          echo "‚è™ Rolling back to version: ${{ github.event.inputs.rollback_version }}"
          # helm rollback docuquery -n docuquery-production
          # OR deploy specific version:
          # helm upgrade --install docuquery ./docuquery/helm/docuquery/ \
          #   -f ./docuquery/helm/docuquery/values-production.yaml \
          #   --set image.tag=${{ github.event.inputs.rollback_version }}
          echo "‚úÖ Rollback completed"

  # ===========================================
  # Notifications
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deployment]
    if: always()
    
    steps:
      - name: Deployment Success Notification
        if: ${{ needs.deploy-production.result == 'success' && needs.post-deployment.result == 'success' }}
        run: |
          echo "‚úÖ Production deployment successful!"
          echo "## üéâ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **Production** |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.preflight.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://docuquery.example.com |" >> $GITHUB_STEP_SUMMARY
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"‚úÖ DocuQuery production deployment successful! Version: ${{ needs.preflight.outputs.version }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Deployment Failure Notification
        if: ${{ needs.deploy-production.result == 'failure' || needs.post-deployment.result == 'failure' }}
        run: |
          echo "‚ùå Production deployment failed!"
          echo "## ‚ùå Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs and consider rollback." >> $GITHUB_STEP_SUMMARY
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"‚ùå DocuQuery production deployment FAILED! Immediate attention required."}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Release
        if: ${{ needs.deploy-production.result == 'success' && startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## DocuQuery Release ${{ github.ref_name }}
            
            ### Deployment Info
            - **Environment**: Production
            - **Image**: `${{ needs.build-image.outputs.image }}`
            - **Deployed**: ${{ github.event.head_commit.timestamp }}
